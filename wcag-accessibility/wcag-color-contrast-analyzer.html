<!DOCTYPE html>
<html lang="en" data-theme="auto" data-theme-preference="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WCAG Color Contrast Analyzer - CAnalyzerAI</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Test-specific styles */
        .contrast-analyzer {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .analyzer-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--muted-border);
            backdrop-filter: var(--blur-md) saturate(180%);
            -webkit-backdrop-filter: var(--blur-md) saturate(180%);
            box-shadow: var(--glass-shadow-sm);
        }

        .theme-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .theme-button {
            padding: 12px 24px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .theme-button:hover,
        .theme-button.active {
            background: var(--accent-glow);
            color: white;
            border-color: var(--accent-glow);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
        }

        .contrast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .contrast-test-card {
            background: var(--card-bg);
            border: 1px solid var(--muted-border);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: var(--blur-md) saturate(180%);
            -webkit-backdrop-filter: var(--blur-md) saturate(180%);
            box-shadow: var(--glass-shadow-sm);
            transition: all 0.3s ease;
        }

        .contrast-test-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--glass-shadow-md);
            border-color: var(--accent-glow);
        }

        .test-title {
            font-family: var(--font-family-heading);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-sample {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .sample-text {
            font-weight: 600;
            font-size: 16px;
        }

        .contrast-ratio {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid;
        }

        .ratio-aaa {
            background: rgba(0, 200, 0, 0.1);
            color: #00c800;
            border-color: #00c800;
        }

        .ratio-aa {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border-color: #ffc107;
        }

        .ratio-fail {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border-color: #dc3545;
        }

        .compliance-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-aaa {
            background: #00c800;
            color: white;
        }

        .badge-aa {
            background: #ffc107;
            color: black;
        }

        .badge-fail {
            background: #dc3545;
            color: white;
        }

        .summary-section {
            background: var(--card-bg);
            border: 1px solid var(--muted-border);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: var(--blur-md) saturate(180%);
            -webkit-backdrop-filter: var(--blur-md) saturate(180%);
            box-shadow: var(--glass-shadow-sm);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--glass-shadow-md);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recommendations {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            border-left: 4px solid var(--accent-magenta);
        }

        .recommendation-text {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.5;
        }

        .improved-colors {
            margin-top: 24px;
            padding: 20px;
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }

        .color-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .before-after {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .before {
            border: 2px dashed #dc3545;
        }

        .after {
            border: 2px solid #00c800;
        }

        .auto-fix-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--accent-glow);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .auto-fix-button:hover {
            background: #5a52e6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 99, 255, 0.4);
        }

        .detailed-analysis {
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #00c800);
            transition: width 0.5s ease;
        }

        @media (max-width: 768px) {
            .contrast-grid {
                grid-template-columns: 1fr;
            }
            
            .theme-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .color-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced Theme Toggle -->
    <header class="header">
        <div class="header-content">
            <h1 class="app-title">
                <span class="title-icon">üîç</span>
                WCAG Color Contrast Analyzer
            </h1>
            
            <div class="theme-toggle-container">
                <button id="themeToggle" class="theme-toggle" role="switch" aria-checked="auto" aria-label="Theme toggle" tabindex="0">
                    <span class="theme-track">
                        <span class="theme-thumb"></span>
                    </span>
                    <span id="themeToggleLabel" class="theme-label">Auto</span>
                </button>
                
                <div id="themeOptions" class="theme-options" role="menu" aria-labelledby="themeToggle">
                    <button class="theme-option active" data-theme="auto" role="menuitem" tabindex="0">
                        <span class="theme-icon">üåô‚òÄÔ∏è</span>
                        <span class="theme-text">Auto</span>
                        <span class="theme-description">Follow system</span>
                    </button>
                    <button class="theme-option" data-theme="light" role="menuitem" tabindex="0">
                        <span class="theme-icon">‚òÄÔ∏è</span>
                        <span class="theme-text">Light</span>
                        <span class="theme-description">Always light</span>
                    </button>
                    <button class="theme-option" data-theme="dark" role="menuitem" tabindex="0">
                        <span class="theme-icon">üåô</span>
                        <span class="theme-text">Dark</span>
                        <span class="theme-description">Always dark</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="contrast-analyzer">
        <div class="analyzer-header">
            <h1 style="margin: 0 0 20px; color: var(--text-primary); font-family: var(--font-family-heading);">
                üé® WCAG 2.1 AA/AAA Color Contrast Analysis
            </h1>
            <p style="margin: 0; color: var(--text-secondary); font-size: 16px;">
                Comprehensive accessibility compliance testing for all theme color combinations
            </p>
            
            <div class="theme-selector">
                <button class="theme-button active" data-analyze-theme="current">Current Theme</button>
                <button class="theme-button" data-analyze-theme="light">Light Theme</button>
                <button class="theme-button" data-analyze-theme="dark">Dark Theme</button>
                <button class="theme-button" data-analyze-theme="all">All Themes</button>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section">
            <h2 style="margin: 0 0 20px; color: var(--text-primary); font-family: var(--font-family-heading);">
                üìä Compliance Summary
            </h2>
            
            <div class="progress-bar">
                <div class="progress-fill" id="complianceProgress" style="width: 0%"></div>
            </div>
            
            <div class="summary-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">Total Tests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="aaaCompliant">0</div>
                    <div class="stat-label">AAA Compliant</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="aaCompliant">0</div>
                    <div class="stat-label">AA Compliant</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="failedTests">0</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overallScore">0%</div>
                    <div class="stat-label">Overall Score</div>
                </div>
            </div>

            <div class="recommendations" id="recommendationsContainer">
                <h3 style="margin: 0 0 16px; color: var(--text-primary);">üìã Recommendations</h3>
                <div id="recommendationsList">
                    <div class="recommendation-item">
                        <span>üí°</span>
                        <div class="recommendation-text">Click "Analyze Current Theme" to start accessibility testing</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results Grid -->
        <div class="contrast-grid" id="testResultsGrid">
            <!-- Dynamic test results will be inserted here -->
        </div>

        <!-- Improved Colors Section -->
        <div class="improved-colors" id="improvedColorsSection" style="display: none;">
            <h3 style="margin: 0 0 20px; color: var(--text-primary); font-family: var(--font-family-heading);">
                üîß Suggested Color Improvements
            </h3>
            
            <button class="auto-fix-button" id="autoFixButton">
                <span>üî®</span>
                Apply Auto-Fix Colors
            </button>
            
            <div id="colorImprovements">
                <!-- Dynamic improvements will be inserted here -->
            </div>
        </div>

        <!-- Detailed Analysis Log -->
        <div class="detailed-analysis" id="analysisLog">
            <strong>Analysis Log:</strong><br>
            Ready to analyze color contrast ratios...
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        // WCAG Color Contrast Analyzer
        class WCAGContrastAnalyzer {
            constructor() {
                this.results = {
                    total: 0,
                    aaa: 0,
                    aa: 0,
                    failed: 0
                };
                this.improvements = [];
                this.currentTheme = 'current';
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.log('WCAG Color Contrast Analyzer initialized');
                
                // Auto-analyze current theme on load
                setTimeout(() => {
                    this.analyzeTheme('current');
                }, 1000);
            }

            setupEventListeners() {
                // Theme analysis buttons
                document.querySelectorAll('[data-analyze-theme]').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const theme = e.target.dataset.analyzeTheme;
                        this.setActiveAnalysisButton(e.target);
                        this.analyzeTheme(theme);
                    });
                });

                // Auto-fix button
                document.getElementById('autoFixButton')?.addEventListener('click', () => {
                    this.applyAutoFix();
                });

                // Listen for theme changes to re-analyze
                window.addEventListener('themechange', () => {
                    if (this.currentTheme === 'current') {
                        setTimeout(() => this.analyzeTheme('current'), 100);
                    }
                });
            }

            setActiveAnalysisButton(activeButton) {
                document.querySelectorAll('[data-analyze-theme]').forEach(btn => {
                    btn.classList.remove('active');
                });
                activeButton.classList.add('active');
            }

            analyzeTheme(theme) {
                this.currentTheme = theme;
                this.log(`Starting analysis for ${theme} theme...`);
                
                this.results = { total: 0, aaa: 0, aa: 0, failed: 0 };
                this.improvements = [];

                if (theme === 'all') {
                    this.analyzeAllThemes();
                } else {
                    this.analyzeSingleTheme(theme);
                }
            }

            async analyzeAllThemes() {
                const themes = ['light', 'dark'];
                let allResults = [];

                for (const theme of themes) {
                    this.log(`Analyzing ${theme} theme...`);
                    const themeResults = await this.getThemeColorCombinations(theme);
                    allResults = allResults.concat(themeResults);
                }

                this.processResults(allResults);
                this.displayResults(allResults);
                this.updateSummary();
            }

            async analyzeSingleTheme(theme) {
                const colorCombinations = await this.getThemeColorCombinations(theme);
                this.processResults(colorCombinations);
                this.displayResults(colorCombinations);
                this.updateSummary();
            }

            async getThemeColorCombinations(theme) {
                // Temporarily switch to theme to get computed values
                const originalTheme = document.documentElement.getAttribute('data-theme');
                
                if (theme !== 'current') {
                    document.documentElement.setAttribute('data-theme', theme);
                    await this.wait(50); // Allow theme transition
                }

                const computedStyle = getComputedStyle(document.documentElement);
                
                const colors = {
                    textPrimary: this.getCSSVarValue(computedStyle, '--text-primary'),
                    textSecondary: this.getCSSVarValue(computedStyle, '--text-secondary'),
                    textMuted: this.getCSSVarValue(computedStyle, '--text-muted'),
                    bgPrimary: this.getCSSVarValue(computedStyle, '--bg-primary'),
                    bgSecondary: this.getCSSVarValue(computedStyle, '--bg-secondary'),
                    bgGlass: this.getCSSVarValue(computedStyle, '--bg-glass'),
                    surface: this.getCSSVarValue(computedStyle, '--surface'),
                    cardBg: this.getCSSVarValue(computedStyle, '--card-bg'),
                    accentGlow: this.getCSSVarValue(computedStyle, '--accent-glow'),
                    accentCyan: this.getCSSVarValue(computedStyle, '--accent-cyan'),
                    accentMagenta: this.getCSSVarValue(computedStyle, '--accent-magenta'),
                    borderColor: this.getCSSVarValue(computedStyle, '--border-color')
                };

                // Restore original theme
                if (theme !== 'current' && originalTheme) {
                    document.documentElement.setAttribute('data-theme', originalTheme);
                }

                return this.generateColorCombinations(colors, theme);
            }

            getCSSVarValue(computedStyle, varName) {
                const value = computedStyle.getPropertyValue(varName).trim();
                return this.normalizeColor(value);
            }

            normalizeColor(color) {
                // Handle rgba values by converting to hex
                if (color.startsWith('rgba(') || color.startsWith('rgb(')) {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = color;
                    return ctx.fillStyle;
                }
                return color;
            }

            generateColorCombinations(colors, themeName) {
                const combinations = [];

                // Critical text/background combinations
                const criticalCombinations = [
                    { fg: colors.textPrimary, bg: colors.bgPrimary, name: 'Primary Text on Primary Background', critical: true },
                    { fg: colors.textSecondary, bg: colors.bgPrimary, name: 'Secondary Text on Primary Background', critical: true },
                    { fg: colors.textPrimary, bg: colors.cardBg, name: 'Primary Text on Card Background', critical: true },
                    { fg: colors.textSecondary, bg: colors.cardBg, name: 'Secondary Text on Card Background', critical: true },
                    { fg: colors.textPrimary, bg: colors.surface, name: 'Primary Text on Surface', critical: true },
                    { fg: colors.textMuted, bg: colors.bgPrimary, name: 'Muted Text on Primary Background', critical: false },
                ];

                // Interactive element combinations
                const interactiveCombinations = [
                    { fg: '#ffffff', bg: colors.accentGlow, name: 'White Text on Accent Glow (Buttons)', critical: true },
                    { fg: colors.textPrimary, bg: colors.accentCyan, name: 'Primary Text on Accent Cyan', critical: false },
                    { fg: colors.textPrimary, bg: colors.accentMagenta, name: 'Primary Text on Accent Magenta', critical: false },
                    { fg: colors.accentGlow, bg: colors.bgPrimary, name: 'Accent Glow on Primary Background', critical: true },
                    { fg: colors.accentCyan, bg: colors.bgPrimary, name: 'Accent Cyan on Primary Background', critical: true },
                ];

                // Link and focus combinations
                const linkCombinations = [
                    { fg: colors.accentGlow, bg: colors.cardBg, name: 'Accent Links on Cards', critical: true },
                    { fg: colors.accentCyan, bg: colors.surface, name: 'Cyan Links on Surface', critical: true },
                    { fg: colors.borderColor, bg: colors.bgPrimary, name: 'Border Color Visibility', critical: false },
                ];

                const allCombinations = [...criticalCombinations, ...interactiveCombinations, ...linkCombinations];

                allCombinations.forEach(combo => {
                    const result = this.calculateContrastRatio(combo.fg, combo.bg);
                    combinations.push({
                        ...combo,
                        theme: themeName,
                        contrastRatio: result.ratio,
                        compliance: result.compliance,
                        wcagLevel: result.wcagLevel
                    });
                });

                return combinations;
            }

            calculateContrastRatio(foreground, background) {
                const fgLum = this.getLuminance(foreground);
                const bgLum = this.getLuminance(background);
                
                const lighter = Math.max(fgLum, bgLum);
                const darker = Math.min(fgLum, bgLum);
                
                const ratio = (lighter + 0.05) / (darker + 0.05);
                
                let compliance = 'fail';
                let wcagLevel = 'Fail';
                
                if (ratio >= 7) {
                    compliance = 'aaa';
                    wcagLevel = 'AAA';
                } else if (ratio >= 4.5) {
                    compliance = 'aa';
                    wcagLevel = 'AA';
                } else if (ratio >= 3) {
                    compliance = 'aa-large';
                    wcagLevel = 'AA Large';
                }

                return {
                    ratio: Math.round(ratio * 100) / 100,
                    compliance,
                    wcagLevel
                };
            }

            getLuminance(color) {
                const rgb = this.hexToRgb(color);
                if (!rgb) return 0;

                const [r, g, b] = [rgb.r, rgb.g, rgb.b].map(c => {
                    c = c / 255;
                    return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
                });

                return 0.2126 * r + 0.7152 * g + 0.0722 * b;
            }

            hexToRgb(hex) {
                if (!hex) return null;
                
                // Handle different color formats
                if (hex.startsWith('#')) {
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? {
                        r: parseInt(result[1], 16),
                        g: parseInt(result[2], 16),
                        b: parseInt(result[3], 16)
                    } : null;
                }
                
                // Handle rgb() format
                const rgbMatch = hex.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                if (rgbMatch) {
                    return {
                        r: parseInt(rgbMatch[1]),
                        g: parseInt(rgbMatch[2]),
                        b: parseInt(rgbMatch[3])
                    };
                }

                return null;
            }

            processResults(results) {
                this.results.total = results.length;
                this.results.aaa = results.filter(r => r.compliance === 'aaa').length;
                this.results.aa = results.filter(r => r.compliance === 'aa' || r.compliance === 'aa-large').length;
                this.results.failed = results.filter(r => r.compliance === 'fail').length;

                // Generate improvements for failed tests
                results.filter(r => r.compliance === 'fail').forEach(result => {
                    const improvement = this.generateImprovement(result);
                    if (improvement) {
                        this.improvements.push(improvement);
                    }
                });
            }

            generateImprovement(failedResult) {
                // Calculate improved colors that would meet AA standards
                const targetRatio = 4.5;
                const currentRatio = failedResult.contrastRatio;
                
                if (currentRatio >= targetRatio) return null;

                // Simple improvement: darken background or lighten text
                const improvedColors = this.improveColorPair(failedResult.fg, failedResult.bg, targetRatio);
                
                return {
                    original: failedResult,
                    improved: improvedColors,
                    cssVar: this.inferCSSVariable(failedResult.name)
                };
            }

            improveColorPair(fg, bg, targetRatio) {
                // This is a simplified improvement algorithm
                // In practice, you'd want more sophisticated color theory
                
                const fgRgb = this.hexToRgb(fg);
                const bgRgb = this.hexToRgb(bg);
                
                if (!fgRgb || !bgRgb) return null;

                // Strategy: darken foreground or lighten background
                const improvedFg = this.adjustBrightness(fgRgb, -20);
                const improvedBg = this.adjustBrightness(bgRgb, 20);
                
                return {
                    foreground: this.rgbToHex(improvedFg),
                    background: this.rgbToHex(improvedBg)
                };
            }

            adjustBrightness(rgb, amount) {
                return {
                    r: Math.max(0, Math.min(255, rgb.r + amount)),
                    g: Math.max(0, Math.min(255, rgb.g + amount)),
                    b: Math.max(0, Math.min(255, rgb.b + amount))
                };
            }

            rgbToHex(rgb) {
                return `#${((1 << 24) + (rgb.r << 16) + (rgb.g << 8) + rgb.b).toString(16).slice(1)}`;
            }

            inferCSSVariable(testName) {
                const varMap = {
                    'Primary Text': '--text-primary',
                    'Secondary Text': '--text-secondary',
                    'Muted Text': '--text-muted',
                    'Primary Background': '--bg-primary',
                    'Card Background': '--card-bg',
                    'Surface': '--surface',
                    'Accent Glow': '--accent-glow',
                    'Accent Cyan': '--accent-cyan',
                    'Accent Magenta': '--accent-magenta'
                };

                for (const [key, variable] of Object.entries(varMap)) {
                    if (testName.includes(key)) {
                        return variable;
                    }
                }

                return null;
            }

            displayResults(results) {
                const grid = document.getElementById('testResultsGrid');
                grid.innerHTML = '';

                // Group results by theme
                const groupedResults = this.groupBy(results, 'theme');

                Object.entries(groupedResults).forEach(([theme, themeResults]) => {
                    const themeCard = this.createThemeCard(theme, themeResults);
                    grid.appendChild(themeCard);
                });

                // Show improvements if any failures
                if (this.improvements.length > 0) {
                    this.displayImprovements();
                }
            }

            createThemeCard(theme, results) {
                const card = document.createElement('div');
                card.className = 'contrast-test-card';
                
                const themeTitle = theme.charAt(0).toUpperCase() + theme.slice(1);
                const passCount = results.filter(r => r.compliance !== 'fail').length;
                const totalCount = results.length;
                const passRate = Math.round((passCount / totalCount) * 100);

                card.innerHTML = `
                    <div class="test-title">
                        <span>üé®</span>
                        ${themeTitle} Theme Analysis
                        <div class="compliance-badge badge-${passRate >= 90 ? 'aaa' : passRate >= 70 ? 'aa' : 'fail'}">
                            ${passRate}% Pass
                        </div>
                    </div>
                    
                    ${results.map(result => `
                        <div class="color-sample" style="background: ${result.bg}; color: ${result.fg};">
                            <div class="sample-text">${result.name}</div>
                            <div class="contrast-ratio ratio-${result.compliance}">
                                ${result.contrastRatio}:1 (${result.wcagLevel})
                            </div>
                        </div>
                    `).join('')}
                `;

                return card;
            }

            displayImprovements() {
                const section = document.getElementById('improvedColorsSection');
                const container = document.getElementById('colorImprovements');
                
                section.style.display = 'block';
                
                container.innerHTML = this.improvements.map(improvement => `
                    <div class="color-comparison">
                        <div class="before-after before" style="background: ${improvement.original.bg}; color: ${improvement.original.fg};">
                            <strong>Before:</strong> ${improvement.original.contrastRatio}:1<br>
                            ${improvement.original.name}
                        </div>
                        <div class="before-after after" style="background: ${improvement.improved?.background}; color: ${improvement.improved?.foreground};">
                            <strong>After:</strong> Improved<br>
                            ${improvement.cssVar || 'Custom adjustment'}
                        </div>
                    </div>
                `).join('');
            }

            updateSummary() {
                document.getElementById('totalTests').textContent = this.results.total;
                document.getElementById('aaaCompliant').textContent = this.results.aaa;
                document.getElementById('aaCompliant').textContent = this.results.aa;
                document.getElementById('failedTests').textContent = this.results.failed;
                
                const successRate = this.results.total > 0 
                    ? Math.round(((this.results.aaa + this.results.aa) / this.results.total) * 100)
                    : 0;
                    
                document.getElementById('overallScore').textContent = `${successRate}%`;
                
                // Update progress bar
                const progressFill = document.getElementById('complianceProgress');
                if (progressFill) {
                    progressFill.style.width = `${successRate}%`;
                }

                // Update recommendations
                this.updateRecommendations(successRate);
            }

            updateRecommendations(successRate) {
                const container = document.getElementById('recommendationsList');
                let recommendations = [];

                if (successRate < 70) {
                    recommendations.push({
                        icon: '‚ö†Ô∏è',
                        text: 'Critical accessibility issues detected. Immediate color adjustments required for WCAG compliance.'
                    });
                }

                if (this.results.failed > 0) {
                    recommendations.push({
                        icon: 'üîß',
                        text: `${this.results.failed} color combinations need improvement. Consider using the auto-fix suggestions.`
                    });
                }

                if (successRate >= 90) {
                    recommendations.push({
                        icon: 'üéâ',
                        text: 'Excellent accessibility compliance! Your color scheme meets high standards.'
                    });
                } else if (successRate >= 70) {
                    recommendations.push({
                        icon: 'üëç',
                        text: 'Good accessibility foundation. A few improvements would reach AAA standards.'
                    });
                }

                recommendations.push({
                    icon: 'üì±',
                    text: 'Test on actual devices and with screen readers for complete accessibility validation.'
                });

                container.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-item">
                        <span>${rec.icon}</span>
                        <div class="recommendation-text">${rec.text}</div>
                    </div>
                `).join('');
            }

            applyAutoFix() {
                this.log('Applying auto-fix improvements...');
                
                // This would apply the suggested color improvements
                // For now, we'll simulate the process
                
                this.improvements.forEach(improvement => {
                    if (improvement.cssVar && improvement.improved) {
                        this.log(`Updating ${improvement.cssVar} for better contrast`);
                        // In a real implementation, you would update the CSS variables
                    }
                });

                this.log('Auto-fix completed. Re-analyzing...');
                setTimeout(() => {
                    this.analyzeTheme(this.currentTheme);
                }, 1000);
            }

            groupBy(array, key) {
                return array.reduce((result, item) => {
                    const group = item[key];
                    if (!result[group]) {
                        result[group] = [];
                    }
                    result[group].push(item);
                    return result;
                }, {});
            }

            log(message) {
                const logElement = document.getElementById('analysisLog');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${message}\n`;
                
                if (logElement) {
                    logElement.innerHTML += logEntry;
                    logElement.scrollTop = logElement.scrollHeight;
                }
                
                console.log(`[WCAG Analyzer] ${message}`);
            }

            wait(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Initialize analyzer when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                if (window.themeManager) {
                    window.contrastAnalyzer = new WCAGContrastAnalyzer();
                    console.log('üîç WCAG Color Contrast Analyzer ready');
                } else {
                    console.error('‚ùå Theme manager not found - cannot initialize analyzer');
                }
            }, 100);
        });
    </script>
</body>
</html>
