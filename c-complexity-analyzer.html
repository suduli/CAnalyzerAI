<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAnalyzerAI - AI-Powered C Code Analysis</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="enhanced-data-display.css" />
    <link rel="stylesheet" href="enhanced-light-theme.css" />
    <link rel="stylesheet" href="glassmorphic-effects.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Glassmorphic Particle System - Enhanced visual effects -->
    <canvas id="glassmorphic-particles"></canvas>
    
    <!-- Matrix Particle System - positioned behind everything -->
    <div id="particles-js" class="matrix-particles"></div>
    
    <!-- Light Theme Particle System -->
    <div id="light-particles-js" class="light-particles"></div>
    
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="app-title"><span class="title-icon">‚ö°</span> CAnalyzerAI</h1>
                    <div class="version">AI-Powered Edition</div>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <a href="index.html" class="btn btn--outline btn--sm">
                            <span class="btn-icon">üè†</span>
                            <span class="btn-text">Main App</span>
                        </a>
                        <div class="theme-toggle-container">
                            <div class="theme-toggle" id="themeToggle" role="switch" aria-label="Toggle dark/light mode" tabindex="0">
                                <div class="theme-toggle-track">
                                    <div class="theme-toggle-thumb" id="themeToggleThumb">
                                        <span class="theme-icon theme-icon-sun">‚òÄÔ∏è</span>
                                        <span class="theme-icon theme-icon-moon">üåô</span>
                                    </div>
                                </div>
                                <div class="theme-toggle-label" id="themeToggleLabel">Auto</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="upload-section" role="main" aria-labelledby="analyzer-section-title">
            <div class="upload-container">
                <div class="section-header">
                    <h2 id="analyzer-section-title"><span class="section-icon">ü§ñ</span>AI-Powered C Code Analysis</h2>
                    <p class="section-subtitle">Advanced complexity analysis using artificial intelligence</p>
                </div>

                <!-- API Key Configuration -->
                <div class="api-key-section">
                    <div class="form-group">
                        <label for="apiKey" class="form-label">OpenRouter API Key</label>
                        <div class="api-key-input-wrapper">
                            <input type="password" id="apiKey" class="form-control api-key-input" placeholder="Enter your OpenRouter API key" autocomplete="off" spellcheck="false">
                            <button type="button" class="key-toggle-btn" id="keyToggleBtn" title="Show/Hide Key"><span class="key-toggle-icon">üëÅÔ∏è</span></button>
                        </div>
                        <div class="form-hint">
                            Get your API key from <a href="https://openrouter.ai/keys" target="_blank" rel="noopener noreferrer">OpenRouter</a>
                        </div>
                    </div>
                </div>

                <!-- File Upload Area -->
                <div 
                    class="upload-zone" 
                    id="uploadZone"
                    role="button"
                    tabindex="0"
                    aria-label="File upload area. Click to browse for C code files or drag and drop files here."
                    data-upload-state="empty"
                >
                    <div class="upload-content">
                        <div class="upload-icon" aria-hidden="true">üìÅ</div>
                        <h3 class="upload-title">Drop your C code file here</h3>
                        <p class="upload-subtitle">or click to browse</p>
                        <div class="file-requirements">
                            <span class="requirement">.c files only</span>
                            <span class="requirement">Max 5MB</span>
                        </div>
                    </div>
                    <input 
                        type="file" 
                        id="fileInput" 
                        accept=".c" 
                        class="file-input"
                        aria-label="Choose C code file to upload"
                    >
                </div>

                <!-- Code Display -->
                <div id="codeDisplay" class="code-display hidden"></div>

                <!-- Error Messages -->
                <div 
                    class="error-message hidden" 
                    id="errorMessage" 
                    role="alert" 
                    aria-live="assertive"
                ></div>

                <!-- Analysis Button -->
                <div class="analysis-controls">
                    <button id="analyzeBtn" class="btn btn--primary" disabled>
                        <span class="btn-icon">üöÄ</span>
                        <span class="btn-text">Analyze Code Complexity</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Loading Overlay -->
        <div class="loading-overlay hidden" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">Analyzing your code with AI...</div>
            </div>
        </div>

        <!-- Results Section -->
        <section class="results-section hidden" id="resultsSection">
            <div class="results-header">
                <h2><span class="section-icon">üìä</span>AI Analysis Results</h2>
                <div class="results-actions">
                    <button class="btn btn--outline btn--sm" id="exportResults" title="Download results as JSON">
                        <span class="btn-icon">üíæ</span>Export JSON
                    </button>
                    <button class="btn btn--outline btn--sm" id="newAnalysis" title="Start a new analysis">
                        <span class="btn-icon">üîÑ</span>New Analysis
                    </button>
                </div>
            </div>

            <div class="results-grid">
                <div class="analysis-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><span class="panel-icon">ü§ñ</span> AI-Powered Metrics</h3>
                    </div>
                    <div class="panel-content">
                        <div class="complexity-section">
                            <div class="complexity-metrics" id="resultsGrid">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analysis-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><span class="panel-icon">üìù</span> Analysis Notes</h3>
                    </div>
                    <div class="panel-content">
                        <div id="notesSection" class="notes-content">
                            <!-- Notes will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- MISRA Analysis Panel -->
                <div class="analysis-panel" id="misraPanel">
                    <div class="panel-header">
                        <h3 class="panel-title"><span class="panel-icon">üõ°Ô∏è</span> MISRA C Analysis</h3>
                        <div class="misra-compliance-badge" id="misraComplianceBadge">
                            <span id="misraComplianceText">Calculating...</span>
                        </div>
                    </div>
                    <div class="panel-content">
                        <div class="misra-summary" id="misraSummary">
                            <div class="misra-stat">
                                <div class="misra-stat-value" id="misraViolationCount">0</div>
                                <div class="misra-stat-label">Total Violations</div>
                            </div>
                            <div class="misra-stat">
                                <div class="misra-stat-value" id="misraCriticalCount">0</div>
                                <div class="misra-stat-label">Critical Issues</div>
                            </div>
                            <div class="misra-stat">
                                <div class="misra-stat-value" id="misraCompliance">0%</div>
                                <div class="misra-stat-label">Compliance</div>
                            </div>
                        </div>
                        <div class="misra-violations" id="misraViolations">
                            <!-- MISRA violations will be populated here -->
                        </div>
                        <div class="misra-actions">
                            <button class="btn btn--outline btn--sm" id="explainMisraBtn" style="display: none;">
                                <span class="btn-icon">üí°</span>Explain MISRA Findings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-content">
                <div class="footer-main">
                    <div class="footer-section footer-brand">
                        <h3 class="footer-brand-title">CAnalyzerAI</h3>
                        <p class="footer-brand-subtitle">Advanced C Code Complexity Analysis</p>
                        <p class="footer-copyright">&copy; 2025 Suduli. All rights reserved.</p>
                    </div>
                    
                    <div class="footer-section footer-connect">
                        <h4 class="footer-section-title">Connect</h4>
                        <div class="footer-social-links">
                            <a href="https://github.com/suduli/CAnalyzerAI" target="_blank" rel="noopener noreferrer" class="social-link-modern" title="GitHub Repository">
                                <svg class="social-icon-svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                                <span>GitHub</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <div class="footer-brand-credit">
                        <span class="brand-credit-text">Design And Implemented By Suduli</span>
                    </div>
                    <div class="footer-version">
                        <span>AI-Powered Edition</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="glassmorphic-particles.js"></script>
    <script src="matrix-particles.js"></script>
    <script src="light-theme-particles.js"></script>
    
    <style>
        /* MISRA Analysis Styles */
        .misra-compliance-badge {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.8em;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .misra-compliance-badge.excellent {
            background: rgba(76, 175, 80, 0.2);
            border-color: rgba(76, 175, 80, 0.4);
            color: #4caf50;
        }

        .misra-compliance-badge.good {
            background: rgba(76, 175, 80, 0.15);
            border-color: rgba(76, 175, 80, 0.3);
            color: #81c784;
        }

        .misra-compliance-badge.warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.4);
            color: #ffc107;
        }

        .misra-compliance-badge.critical {
            background: rgba(244, 67, 54, 0.2);
            border-color: rgba(244, 67, 54, 0.4);
            color: #f44336;
        }

        .misra-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .misra-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition-smooth);
        }

        .misra-stat:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .misra-stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent-glow);
            display: block;
            margin-bottom: 4px;
        }

        .misra-stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
        }

        .misra-violations {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .misra-violation {
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: var(--transition-smooth);
        }

        .misra-violation:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }

        .misra-violation.severity-mandatory {
            border-left-color: #f44336;
        }

        .misra-violation.severity-required {
            border-left-color: #ff9800;
        }

        .misra-violation.severity-advisory {
            border-left-color: #2196f3;
        }

        .violation-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .rule-number {
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .severity-badge {
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-badge.mandatory {
            background: #f44336;
            color: white;
        }

        .severity-badge.required {
            background: #ff9800;
            color: white;
        }

        .severity-badge.advisory {
            background: #2196f3;
            color: white;
        }

        .line-number {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .violation-description {
            margin-bottom: 12px;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .code-snippet {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-snippet pre {
            margin: 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #e8eaf6;
        }

        .recommendation {
            background: rgba(76, 175, 80, 0.1);
            border-left: 3px solid #4caf50;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }

        .recommendation strong {
            color: #4caf50;
        }

        .no-violations {
            text-align: center;
            padding: 40px 20px;
            color: #4caf50;
            font-size: 1.1em;
            font-weight: 600;
        }

        .misra-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        /* MISRA Modal Styles */
        .misra-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .misra-modal-content {
            background: var(--bg-glass-elevated);
            border-radius: 16px;
            max-width: 800px;
            max-height: 80vh;
            width: 100%;
            overflow: hidden;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--glass-shadow-xl);
        }

        .misra-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .misra-modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-family: var(--font-family-heading);
        }

        .close-misra-modal {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-misra-modal:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .misra-modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .misra-explanation-content {
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .misra-explanation-content h4 {
            color: var(--text-primary);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        .misra-explanation-content ul {
            padding-left: 20px;
        }

        .misra-explanation-content li {
            margin-bottom: 8px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .misra-summary {
                grid-template-columns: 1fr;
            }
            
            .violation-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .misra-modal-content {
                margin: 10px;
                max-height: 90vh;
            }
            
            .misra-actions {
                flex-direction: column;
            }
        }

        /* Loading state for MISRA panel */
        .misra-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .misra-loading::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-glow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <script>
        class CCodeAnalyzer {
            constructor() {
                this.apiKey = '';
                this.codeContent = '';
                this.misraResults = null;
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.apiKeyInput = document.getElementById('apiKey');
                this.fileInput = document.getElementById('fileInput');
                this.fileInputContainer = document.getElementById('fileInputContainer');
                this.codeDisplay = document.getElementById('codeDisplay');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.loading = document.getElementById('loading');
                this.resultsSection = document.getElementById('resultsSection');
                this.resultsGrid = document.getElementById('resultsGrid');
                this.notesSection = document.getElementById('notesSection');
                this.errorMessage = document.getElementById('errorMessage');
                
                // MISRA elements
                this.misraPanel = document.getElementById('misraPanel');
                this.misraComplianceBadge = document.getElementById('misraComplianceBadge');
                this.misraComplianceText = document.getElementById('misraComplianceText');
                this.misraViolationCount = document.getElementById('misraViolationCount');
                this.misraCriticalCount = document.getElementById('misraCriticalCount');
                this.misraCompliance = document.getElementById('misraCompliance');
                this.misraViolations = document.getElementById('misraViolations');
                this.explainMisraBtn = document.getElementById('explainMisraBtn');
            }

            bindEvents() {
                this.apiKeyInput.addEventListener('input', () => {
                    this.apiKey = this.apiKeyInput.value.trim();
                    this.updateAnalyzeButton();
                });

                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.fileInputContainer.addEventListener('click', () => this.fileInput.click());
                this.fileInputContainer.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.fileInputContainer.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                this.fileInputContainer.addEventListener('drop', (e) => this.handleDrop(e));
                this.analyzeBtn.addEventListener('click', () => this.analyzeCode());
                
                // MISRA events
                this.explainMisraBtn.addEventListener('click', () => this.explainMisraFindings());
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file && file.name.endsWith('.c')) {
                    this.readFile(file);
                } else {
                    this.showError('Please select a valid .c file');
                }
            }

            handleDragOver(event) {
                event.preventDefault();
                this.fileInputContainer.classList.add('dragover');
            }

            handleDragLeave(event) {
                event.preventDefault();
                this.fileInputContainer.classList.remove('dragover');
            }

            handleDrop(event) {
                event.preventDefault();
                this.fileInputContainer.classList.remove('dragover');
                
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.c')) {
                        this.readFile(file);
                    } else {
                        this.showError('Please drop a valid .c file');
                    }
                }
            }

            readFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.codeContent = e.target.result;
                    this.displayCode();
                    this.updateAnalyzeButton();
                };
                reader.readAsText(file);
            }

            displayCode() {
                this.codeDisplay.textContent = this.codeContent;
                this.codeDisplay.style.display = 'block';
                this.hideError();
            }

            updateAnalyzeButton() {
                this.analyzeBtn.disabled = !this.apiKey || !this.codeContent;
            }

            async analyzeCode() {
                if (!this.apiKey || !this.codeContent) {
                    this.showError('Please provide API key and select a .c file');
                    return;
                }

                this.showLoading(true);
                this.hideError();
                this.hideResults();
                this.showMisraLoading();

                try {
                    // Run both analyses in parallel
                    const [complexityResults, misraResults] = await Promise.all([
                        this.analyzeComplexity(),
                        this.analyzeMISRA()
                    ]);
                    
                    this.displayResults(complexityResults);
                    this.displayMisraResults(misraResults);
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showError(`Analysis failed: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }

            async analyzeComplexity() {
                const prompt = this.buildComplexityPrompt();
                return await this.callOpenRouterAPI(prompt, 'complexity');
            }

            async analyzeMISRA() {
                const prompt = this.buildMisraPrompt();
                return await this.callOpenRouterAPI(prompt, 'misra');
            }

            buildComplexityPrompt() {
                return `You are a code complexity analyzer. Your task is to analyze C programming language code and return ONLY a valid JSON response.

CRITICAL INSTRUCTIONS:
1. Return ONLY valid JSON. No explanations, no code examples, no markdown formatting, no code blocks, no additional text.
2. Do NOT wrap your response in \`\`\`json or any other markdown formatting.
3. Use the EXACT schema structure below with the EXACT key names.
4. All numeric values must be integers (no decimals, no strings, no written numbers).
5. The response must be parseable by JSON.parse() without any preprocessing.
6. Start your response with { and end with } - nothing before or after.

REQUIRED JSON SCHEMA:
{
  "loc": <integer: count of executable lines excluding comments, blanks, and includes>,
  "complexity1": <integer: cyclomatic complexity (decision points + 1)>,
  "complexity2": <integer: cognitive complexity score>,
  "complexity3": <integer: halstead complexity metric>,
  "notes": ["<string: brief analysis note>"]
}

VALIDATION RULES:
- "loc" must be a positive integer >= 0
- "complexity1" must be a positive integer >= 1
- "complexity2" must be a positive integer >= 0
- "complexity3" must be a positive integer >= 0
- "notes" must be an array of strings
- No additional properties allowed
- No nested objects in numeric fields

EXAMPLE OF EXPECTED RESPONSE FORMAT:
{"loc": 25, "complexity1": 3, "complexity2": 2, "complexity3": 15, "notes": ["Simple function with basic control flow"]}

C CODE TO ANALYZE:

${this.codeContent}`;
            }

            buildMisraPrompt() {
                return `Analyze the following C code for MISRA-C compliance violations. Return results in strict JSON format with no additional text or formatting:

CRITICAL INSTRUCTIONS:
1. Return ONLY valid JSON. No explanations, no markdown formatting, no code blocks.
2. Do NOT wrap your response in \`\`\`json or any other markdown formatting.
3. Start your response with { and end with } - nothing before or after.

REQUIRED JSON SCHEMA:
{
    "misra_violations": [
        {
            "rule": "MISRA rule number (e.g., 1.1, 8.5)",
            "severity": "Required|Advisory|Mandatory",
            "line": line_number,
            "description": "Brief description of violation",
            "code_snippet": "Relevant code snippet",
            "recommendation": "How to fix this violation"
        }
    ],
    "summary": {
        "total_violations": number,
        "critical_count": number,
        "compliance_percentage": number,
        "most_common_violation": "Most frequent rule violation"
    }
}

Focus on common MISRA-C rules like:
- Rule 8.5: Declaration should be in header files
- Rule 12.1: Precedence of operators
- Rule 14.3: Controlling expressions should be boolean
- Rule 15.5: Function should have single exit point
- Rule 16.4: Switch statements should be well-formed
- Rule 20.1: #include directives should only be preceded by preprocessor directives

C Code to analyze:
${this.codeContent}`;
            }

            async callOpenRouterAPI(prompt, analysisType) {
                // Try models in order of preference
                const modelsToTry = [
                    'google/gemini-2.0-flash-exp:free',
                    'google/gemini-2.5-flash:free',
                    'meta-llama/llama-3.1-8b-instruct:free'
                ];

                let lastError = null;

                for (const model of modelsToTry) {
                    try {
                        console.log(`üîÑ Trying model: ${model} for ${analysisType} analysis`);
                        
                        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.apiKey}`,
                                'Content-Type': 'application/json',
                                'HTTP-Referer': window.location.origin,
                                'X-Title': `CAnalyzerAI ${analysisType} Analysis`
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [
                                    {
                                        role: 'user',
                                        content: prompt
                                    }
                                ],
                                temperature: 0.1,
                                max_tokens: analysisType === 'misra' ? 4000 : 1000
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error(`OpenRouter API Error for ${model} (${analysisType}):`, {
                                status: response.status,
                                statusText: response.statusText,
                                errorData
                            });
                            
                            let errorMessage = '';
                            if (response.status === 401) {
                                errorMessage = 'Authentication failed. Please check your OpenRouter API key.';
                            } else if (response.status === 403) {
                                errorMessage = `Access forbidden to model ${model}. Your API key may not have access to this model.`;
                            } else if (response.status === 429) {
                                errorMessage = 'Rate limit exceeded. Please wait a moment and try again.';
                            } else if (response.status === 400) {
                                errorMessage = `Bad request for ${model}: ${errorData.error?.message || 'Invalid request parameters'}`;
                            } else {
                                errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                            }
                            
                            lastError = new Error(errorMessage);
                            
                            // If it's a 401, don't try other models as it's likely an API key issue
                            if (response.status === 401) {
                                throw lastError;
                            }
                            
                            // Try next model
                            continue;
                        }

                        const data = await response.json();
                        const content = data.choices[0]?.message?.content;
                        
                        if (!content) {
                            lastError = new Error(`No response content received from ${model} for ${analysisType}`);
                            continue;
                        }

                        console.log(`‚úÖ Successfully used model: ${model} for ${analysisType} analysis`);

                        // Clean the response content to extract JSON
                        let cleanedContent = this.cleanAIResponse(content);
                        
                        try {
                            return JSON.parse(cleanedContent);
                        } catch (parseError) {
                            // If parsing fails, try to extract JSON from the cleaned content
                            const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                try {
                                    return JSON.parse(jsonMatch[0]);
                                } catch (secondParseError) {
                                    lastError = new Error(`Invalid JSON response from ${model} for ${analysisType}: ${secondParseError.message}. Raw content: ${cleanedContent.substring(0, 200)}...`);
                                    continue;
                                }
                            }
                            lastError = new Error(`Invalid JSON response from ${model} for ${analysisType}: ${parseError.message}. Raw content: ${cleanedContent.substring(0, 200)}...`);
                            continue;
                        }

                    } catch (error) {
                        console.error(`Error with model ${model} for ${analysisType}:`, error);
                        lastError = error;
                        
                        // If it's a network error or auth error, don't try other models
                        if (error.message.includes('Authentication failed') || error.message.includes('Failed to fetch')) {
                            throw error;
                        }
                        
                        // Try next model
                        continue;
                    }
                }

                // If we get here, all models failed
                throw lastError || new Error(`All available models failed to respond for ${analysisType} analysis`);
            }

            cleanAIResponse(content) {
                // Remove markdown code blocks
                let cleaned = content.replace(/```json\s*/gi, '').replace(/```\s*$/gi, '');
                
                // Remove any leading/trailing whitespace
                cleaned = cleaned.trim();
                
                // If the content starts with a { and ends with }, it's likely valid JSON
                if (cleaned.startsWith('{') && cleaned.endsWith('}')) {
                    return cleaned;
                }
                
                // Try to find JSON object in the content
                const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return jsonMatch[0];
                }
                
                return cleaned;
            }

            displayResults(results) {
                // Display metrics
                this.resultsGrid.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${results.loc}</div>
                        <div class="metric-label">Lines of Code</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.complexity1}</div>
                        <div class="metric-label">Cyclomatic Complexity</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.complexity2}</div>
                        <div class="metric-label">Cognitive Complexity</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.complexity3}</div>
                        <div class="metric-label">Halstead Complexity</div>
                    </div>
                `;

                // Display notes
                if (results.notes && results.notes.length > 0) {
                    this.notesSection.innerHTML = `
                        <div class="notes-title">üìù Analysis Notes</div>
                        <ul class="notes-list">
                            ${results.notes.map(note => `<li>${note}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    this.notesSection.innerHTML = `
                        <div class="notes-title">üìù Analysis Notes</div>
                        <p>No specific notes provided by the AI analysis.</p>
                    `;
                }

                this.resultsSection.style.display = 'block';
            }

            displayMisraResults(results) {
                this.misraResults = results;
                
                // Update summary stats
                this.misraViolationCount.textContent = results.summary.total_violations;
                this.misraCriticalCount.textContent = results.summary.critical_count;
                this.misraCompliance.textContent = `${results.summary.compliance_percentage}%`;
                
                // Update compliance badge
                this.updateComplianceBadge(results.summary.compliance_percentage);
                
                // Clear and populate violations
                this.misraViolations.innerHTML = '';
                
                if (results.misra_violations && results.misra_violations.length > 0) {
                    results.misra_violations.forEach((violation, index) => {
                        const violationDiv = document.createElement('div');
                        violationDiv.className = `misra-violation severity-${violation.severity.toLowerCase()}`;
                        
                        violationDiv.innerHTML = `
                            <div class="violation-header">
                                <span class="rule-number">Rule ${violation.rule}</span>
                                <span class="severity-badge ${violation.severity.toLowerCase()}">${violation.severity}</span>
                                <span class="line-number">Line ${violation.line}</span>
                            </div>
                            <div class="violation-description">${violation.description}</div>
                            <div class="code-snippet">
                                <strong>Code:</strong>
                                <pre><code>${violation.code_snippet}</code></pre>
                            </div>
                            <div class="recommendation">
                                <strong>Recommendation:</strong> ${violation.recommendation}
                            </div>
                        `;
                        this.misraViolations.appendChild(violationDiv);
                    });
                    
                    this.explainMisraBtn.style.display = 'block';
                } else {
                    this.misraViolations.innerHTML = '<div class="no-violations">üéâ No MISRA violations found! Your code follows MISRA-C guidelines.</div>';
                    this.explainMisraBtn.style.display = 'none';
                }
            }

            updateComplianceBadge(percentage) {
                let badgeClass = 'critical';
                let badgeText = 'Critical Issues';
                
                if (percentage >= 95) {
                    badgeClass = 'excellent';
                    badgeText = 'Excellent';
                } else if (percentage >= 80) {
                    badgeClass = 'good';
                    badgeText = 'Good';
                } else if (percentage >= 60) {
                    badgeClass = 'warning';
                    badgeText = 'Needs Improvement';
                }
                
                this.misraComplianceBadge.className = `misra-compliance-badge ${badgeClass}`;
                this.misraComplianceText.textContent = badgeText;
            }

            showMisraLoading() {
                this.misraViolations.innerHTML = '<div class="misra-loading">Analyzing MISRA compliance...</div>';
                this.misraViolationCount.textContent = '...';
                this.misraCriticalCount.textContent = '...';
                this.misraCompliance.textContent = '...';
                this.misraComplianceText.textContent = 'Analyzing...';
            }

            async explainMisraFindings() {
                if (!this.misraResults) {
                    this.showError('No MISRA analysis data available');
                    return;
                }

                const btn = this.explainMisraBtn;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="btn-icon">‚è≥</span>Generating Explanation...';
                btn.disabled = true;

                try {
                    const explanationPrompt = `Based on the following MISRA-C analysis results, provide a comprehensive explanation of the findings, their impact on code quality and safety, and prioritized recommendations for improvement.

MISRA Analysis Results:
${JSON.stringify(this.misraResults, null, 2)}

Please provide:
1. Overall assessment of MISRA compliance
2. Critical issues that need immediate attention
3. Impact on code safety and reliability
4. Prioritized action plan for remediation
5. Best practices to prevent future violations

Format your response in clear, structured sections with practical recommendations.`;

                    const explanation = await this.callOpenRouterAPI(explanationPrompt, 'explanation');
                    this.showMisraExplanation(explanation);
                } catch (error) {
                    console.error('MISRA explanation error:', error);
                    this.showError('Failed to generate explanation. Please try again.');
                } finally {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }

            showMisraExplanation(explanation) {
                const modal = document.createElement('div');
                modal.className = 'misra-modal';
                modal.innerHTML = `
                    <div class="misra-modal-content">
                        <div class="misra-modal-header">
                            <h3>MISRA Analysis Explanation</h3>
                            <button class="close-misra-modal" aria-label="Close explanation modal">&times;</button>
                        </div>
                        <div class="misra-modal-body">
                            <div class="misra-explanation-content">
                                ${typeof explanation === 'string' ? explanation.replace(/\n/g, '<br>') : JSON.stringify(explanation, null, 2)}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close modal functionality
                const closeBtn = modal.querySelector('.close-misra-modal');
                closeBtn.addEventListener('click', () => this.closeMisraModal(modal));
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeMisraModal(modal);
                    }
                });
                
                // Keyboard navigation
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeMisraModal(modal);
                    }
                });
                
                closeBtn.focus();
            }

            closeMisraModal(modal) {
                document.body.removeChild(modal);
                this.explainMisraBtn.focus();
            }

            showLoading(show) {
                this.loading.style.display = show ? 'block' : 'none';
                this.analyzeBtn.disabled = show;
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
            }

            hideError() {
                this.errorMessage.style.display = 'none';
            }

            hideResults() {
                this.resultsSection.style.display = 'none';
            }
        }

        // Initialize the analyzer when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CCodeAnalyzer();
        });
    </script>
</body>
</html>
