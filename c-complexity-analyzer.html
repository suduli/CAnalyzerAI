<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAnalyzerAI - AI-Powered C Code Analysis</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="enhanced-data-display.css" />
    <link rel="stylesheet" href="enhanced-light-theme.css" />
    <link rel="stylesheet" href="glassmorphic-effects.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Glassmorphic Particle System - Enhanced visual effects -->
    <canvas id="glassmorphic-particles"></canvas>
    
    <!-- Matrix Particle System - positioned behind everything -->
    <div id="particles-js" class="matrix-particles"></div>
    
    <!-- Light Theme Particle System -->
    <div id="light-particles-js" class="light-particles"></div>
    
    <div class="app-container">
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="app-title"><span class="title-icon">‚ö°</span> CAnalyzerAI</h1>
                    <div class="version">AI-Powered Edition</div>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <a href="index.html" class="btn btn--outline btn--sm">
                            <span class="btn-icon">üè†</span>
                            <span class="btn-text">Main App</span>
                        </a>
                        <div class="theme-toggle-container">
                            <div class="theme-toggle" id="themeToggle" role="switch" aria-label="Toggle dark/light mode" tabindex="0">
                                <div class="theme-toggle-track">
                                    <div class="theme-toggle-thumb" id="themeToggleThumb">
                                        <span class="theme-icon theme-icon-sun">‚òÄÔ∏è</span>
                                        <span class="theme-icon theme-icon-moon">üåô</span>
                                    </div>
                                </div>
                                <div class="theme-toggle-label" id="themeToggleLabel">Auto</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <section class="upload-section" role="main" aria-labelledby="analyzer-section-title">
            <div class="upload-container">
                <div class="section-header">
                    <h2 id="analyzer-section-title"><span class="section-icon">ü§ñ</span>AI-Powered C Code Analysis</h2>
                    <p class="section-subtitle">Advanced complexity analysis using artificial intelligence</p>
                </div>

                <!-- API Key Configuration -->
                <div class="api-key-section">
                    <div class="form-group">
                        <label for="apiKey" class="form-label">OpenRouter API Key</label>
                        <div class="api-key-input-wrapper">
                            <input type="password" id="apiKey" class="form-control api-key-input" placeholder="Enter your OpenRouter API key" autocomplete="off" spellcheck="false">
                            <button type="button" class="key-toggle-btn" id="keyToggleBtn" title="Show/Hide Key"><span class="key-toggle-icon">üëÅÔ∏è</span></button>
                        </div>
                        <div class="form-hint">
                            Get your API key from <a href="https://openrouter.ai/keys" target="_blank" rel="noopener noreferrer">OpenRouter</a>
                        </div>
                    </div>
                </div>

                <!-- File Upload Area -->
                <div 
                    class="upload-zone" 
                    id="uploadZone"
                    role="button"
                    tabindex="0"
                    aria-label="File upload area. Click to browse for C code files or drag and drop files here."
                    data-upload-state="empty"
                >
                    <div class="upload-content">
                        <div class="upload-icon" aria-hidden="true">üìÅ</div>
                        <h3 class="upload-title">Drop your C code file here</h3>
                        <p class="upload-subtitle">or click to browse</p>
                        <div class="file-requirements">
                            <span class="requirement">.c files only</span>
                            <span class="requirement">Max 5MB</span>
                        </div>
                    </div>
                    <input 
                        type="file" 
                        id="fileInput" 
                        accept=".c" 
                        class="file-input"
                        aria-label="Choose C code file to upload"
                    >
                </div>

                <!-- Code Display -->
                <div id="codeDisplay" class="code-display hidden"></div>

                <!-- Error Messages -->
                <div 
                    class="error-message hidden" 
                    id="errorMessage" 
                    role="alert" 
                    aria-live="assertive"
                ></div>

                <!-- Analysis Button -->
                <div class="analysis-controls">
                    <button id="analyzeBtn" class="btn btn--primary" disabled>
                        <span class="btn-icon">üöÄ</span>
                        <span class="btn-text">Analyze Code Complexity</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- Loading Overlay -->
        <div class="loading-overlay hidden" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <div class="loading-text">Analyzing your code with AI...</div>
            </div>
        </div>

        <!-- Results Section -->
        <section class="results-section hidden" id="resultsSection">
            <div class="results-header">
                <h2><span class="section-icon">üìä</span>AI Analysis Results</h2>
                <div class="results-actions">
                    <button class="btn btn--outline btn--sm" id="exportResults" title="Download results as JSON">
                        <span class="btn-icon">üíæ</span>Export JSON
                    </button>
                    <button class="btn btn--outline btn--sm" id="newAnalysis" title="Start a new analysis">
                        <span class="btn-icon">üîÑ</span>New Analysis
                    </button>
                </div>
            </div>

            <div class="results-grid">
                <div class="analysis-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><span class="panel-icon">ü§ñ</span> AI-Powered Metrics</h3>
                    </div>
                    <div class="panel-content">
                        <div class="complexity-section">
                            <div class="complexity-metrics" id="resultsGrid">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analysis-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><span class="panel-icon">üìù</span> Analysis Notes</h3>
                    </div>
                    <div class="panel-content">
                        <div id="notesSection" class="notes-content">
                            <!-- Notes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <div class="footer-content">
                <div class="footer-main">
                    <div class="footer-section footer-brand">
                        <h3 class="footer-brand-title">CAnalyzerAI</h3>
                        <p class="footer-brand-subtitle">Advanced C Code Complexity Analysis</p>
                        <p class="footer-copyright">&copy; 2025 Suduli. All rights reserved.</p>
                    </div>
                    
                    <div class="footer-section footer-connect">
                        <h4 class="footer-section-title">Connect</h4>
                        <div class="footer-social-links">
                            <a href="https://github.com/suduli/CAnalyzerAI" target="_blank" rel="noopener noreferrer" class="social-link-modern" title="GitHub Repository">
                                <svg class="social-icon-svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                                <span>GitHub</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="footer-bottom">
                    <div class="footer-brand-credit">
                        <span class="brand-credit-text">Design And Implemented By Suduli</span>
                    </div>
                    <div class="footer-version">
                        <span>AI-Powered Edition</span>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="glassmorphic-particles.js"></script>
    <script src="matrix-particles.js"></script>
    <script src="light-theme-particles.js"></script>
    <script>
        class CCodeAnalyzer {
            constructor() {
                this.apiKey = '';
                this.codeContent = '';
                this.initializeElements();
                this.bindEvents();
            }

            initializeElements() {
                this.apiKeyInput = document.getElementById('apiKey');
                this.fileInput = document.getElementById('fileInput');
                this.fileInputContainer = document.getElementById('fileInputContainer');
                this.codeDisplay = document.getElementById('codeDisplay');
                this.analyzeBtn = document.getElementById('analyzeBtn');
                this.loading = document.getElementById('loading');
                this.resultsSection = document.getElementById('resultsSection');
                this.resultsGrid = document.getElementById('resultsGrid');
                this.notesSection = document.getElementById('notesSection');
                this.errorMessage = document.getElementById('errorMessage');
            }

            bindEvents() {
                this.apiKeyInput.addEventListener('input', () => {
                    this.apiKey = this.apiKeyInput.value.trim();
                    this.updateAnalyzeButton();
                });

                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.fileInputContainer.addEventListener('click', () => this.fileInput.click());
                this.fileInputContainer.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.fileInputContainer.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                this.fileInputContainer.addEventListener('drop', (e) => this.handleDrop(e));
                this.analyzeBtn.addEventListener('click', () => this.analyzeCode());
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file && file.name.endsWith('.c')) {
                    this.readFile(file);
                } else {
                    this.showError('Please select a valid .c file');
                }
            }

            handleDragOver(event) {
                event.preventDefault();
                this.fileInputContainer.classList.add('dragover');
            }

            handleDragLeave(event) {
                event.preventDefault();
                this.fileInputContainer.classList.remove('dragover');
            }

            handleDrop(event) {
                event.preventDefault();
                this.fileInputContainer.classList.remove('dragover');
                
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.c')) {
                        this.readFile(file);
                    } else {
                        this.showError('Please drop a valid .c file');
                    }
                }
            }

            readFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.codeContent = e.target.result;
                    this.displayCode();
                    this.updateAnalyzeButton();
                };
                reader.readAsText(file);
            }

            displayCode() {
                this.codeDisplay.textContent = this.codeContent;
                this.codeDisplay.style.display = 'block';
                this.hideError();
            }

            updateAnalyzeButton() {
                this.analyzeBtn.disabled = !this.apiKey || !this.codeContent;
            }

            async analyzeCode() {
                if (!this.apiKey || !this.codeContent) {
                    this.showError('Please provide API key and select a .c file');
                    return;
                }

                this.showLoading(true);
                this.hideError();
                this.hideResults();

                try {
                    const prompt = this.buildPrompt();
                    const response = await this.callOpenRouterAPI(prompt);
                    this.displayResults(response);
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showError(`Analysis failed: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }

            buildPrompt() {
                return `You are a code complexity analyzer. Your task is to analyze C programming language code and return ONLY a valid JSON response.

CRITICAL INSTRUCTIONS:
1. Return ONLY valid JSON. No explanations, no code examples, no markdown formatting, no code blocks, no additional text.
2. Do NOT wrap your response in \`\`\`json or any other markdown formatting.
3. Use the EXACT schema structure below with the EXACT key names.
4. All numeric values must be integers (no decimals, no strings, no written numbers).
5. The response must be parseable by JSON.parse() without any preprocessing.
6. Start your response with { and end with } - nothing before or after.

REQUIRED JSON SCHEMA:
{
  "loc": <integer: count of executable lines excluding comments, blanks, and includes>,
  "complexity1": <integer: cyclomatic complexity (decision points + 1)>,
  "complexity2": <integer: cognitive complexity score>,
  "complexity3": <integer: halstead complexity metric>,
  "notes": ["<string: brief analysis note>"]
}

VALIDATION RULES:
- "loc" must be a positive integer >= 0
- "complexity1" must be a positive integer >= 1
- "complexity2" must be a positive integer >= 0
- "complexity3" must be a positive integer >= 0
- "notes" must be an array of strings
- No additional properties allowed
- No nested objects in numeric fields

EXAMPLE OF EXPECTED RESPONSE FORMAT:
{"loc": 25, "complexity1": 3, "complexity2": 2, "complexity3": 15, "notes": ["Simple function with basic control flow"]}

C CODE TO ANALYZE:

${this.codeContent}`;
            }

            async callOpenRouterAPI(prompt) {
                // Try models in order of preference
                const modelsToTry = [
                    'google/gemini-2.0-flash-exp:free',
                    'google/gemini-2.5-flash:free',
                    'meta-llama/llama-3.1-8b-instruct:free'
                ];

                let lastError = null;

                for (const model of modelsToTry) {
                    try {
                        console.log(`üîÑ Trying model: ${model}`);
                        
                        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${this.apiKey}`,
                                'Content-Type': 'application/json',
                                'HTTP-Referer': window.location.origin,
                                'X-Title': 'C Code Complexity Analyzer'
                            },
                            body: JSON.stringify({
                                model: model,
                                messages: [
                                    {
                                        role: 'user',
                                        content: prompt
                                    }
                                ],
                                temperature: 0.1,
                                max_tokens: 1000
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error(`OpenRouter API Error for ${model}:`, {
                                status: response.status,
                                statusText: response.statusText,
                                headers: Object.fromEntries(response.headers.entries()),
                                errorData
                            });
                            
                            let errorMessage = '';
                            if (response.status === 401) {
                                errorMessage = 'Authentication failed. Please check your OpenRouter API key.';
                            } else if (response.status === 403) {
                                errorMessage = `Access forbidden to model ${model}. Your API key may not have access to this model.`;
                            } else if (response.status === 429) {
                                errorMessage = 'Rate limit exceeded. Please wait a moment and try again.';
                            } else if (response.status === 400) {
                                errorMessage = `Bad request for ${model}: ${errorData.error?.message || 'Invalid request parameters'}`;
                            } else {
                                errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                            }
                            
                            lastError = new Error(errorMessage);
                            
                            // If it's a 401, don't try other models as it's likely an API key issue
                            if (response.status === 401) {
                                throw lastError;
                            }
                            
                            // Try next model
                            continue;
                        }

                        const data = await response.json();
                        const content = data.choices[0]?.message?.content;
                        
                        if (!content) {
                            lastError = new Error(`No response content received from ${model}`);
                            continue;
                        }

                        console.log(`‚úÖ Successfully used model: ${model}`);

                        // Clean the response content to extract JSON
                        let cleanedContent = this.cleanAIResponse(content);
                        
                        try {
                            return JSON.parse(cleanedContent);
                        } catch (parseError) {
                            // If parsing fails, try to extract JSON from the cleaned content
                            const jsonMatch = cleanedContent.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                try {
                                    return JSON.parse(jsonMatch[0]);
                                } catch (secondParseError) {
                                    lastError = new Error(`Invalid JSON response from ${model}: ${secondParseError.message}. Raw content: ${cleanedContent.substring(0, 200)}...`);
                                    continue;
                                }
                            }
                            lastError = new Error(`Invalid JSON response from ${model}: ${parseError.message}. Raw content: ${cleanedContent.substring(0, 200)}...`);
                            continue;
                        }

                    } catch (error) {
                        console.error(`Error with model ${model}:`, error);
                        lastError = error;
                        
                        // If it's a network error or auth error, don't try other models
                        if (error.message.includes('Authentication failed') || error.message.includes('Failed to fetch')) {
                            throw error;
                        }
                        
                        // Try next model
                        continue;
                    }
                }

                // If we get here, all models failed
                throw lastError || new Error('All available models failed to respond');
            }

            cleanAIResponse(content) {
                // Remove markdown code blocks
                let cleaned = content.replace(/```json\s*/gi, '').replace(/```\s*$/gi, '');
                
                // Remove any leading/trailing whitespace
                cleaned = cleaned.trim();
                
                // If the content starts with a { and ends with }, it's likely valid JSON
                if (cleaned.startsWith('{') && cleaned.endsWith('}')) {
                    return cleaned;
                }
                
                // Try to find JSON object in the content
                const jsonMatch = cleaned.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return jsonMatch[0];
                }
                
                return cleaned;
            }

            displayResults(results) {
                // Display metrics
                this.resultsGrid.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${results.loc}</div>
                        <div class="metric-label">Lines of Code</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.complexity1}</div>
                        <div class="metric-label">Cyclomatic Complexity</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.complexity2}</div>
                        <div class="metric-label">Cognitive Complexity</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${results.complexity3}</div>
                        <div class="metric-label">Halstead Complexity</div>
                    </div>
                `;

                // Display notes
                if (results.notes && results.notes.length > 0) {
                    this.notesSection.innerHTML = `
                        <div class="notes-title">üìù Analysis Notes</div>
                        <ul class="notes-list">
                            ${results.notes.map(note => `<li>${note}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    this.notesSection.innerHTML = `
                        <div class="notes-title">üìù Analysis Notes</div>
                        <p>No specific notes provided by the AI analysis.</p>
                    `;
                }

                this.resultsSection.style.display = 'block';
            }

            showLoading(show) {
                this.loading.style.display = show ? 'block' : 'none';
                this.analyzeBtn.disabled = show;
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.style.display = 'block';
            }

            hideError() {
                this.errorMessage.style.display = 'none';
            }

            hideResults() {
                this.resultsSection.style.display = 'none';
            }
        }

        // Initialize the analyzer when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new CCodeAnalyzer();
        });
    </script>
</body>
</html>
