<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproduce Data Discrepancy</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #1e2435; 
            color: #e0e6ed; 
        }
        .analysis-section { 
            background: rgba(42, 56, 79, 0.8); 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: rgba(30, 36, 53, 0.5);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #39ff14;
            margin: 10px 0;
        }
        .metric-label {
            color: #8892b0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .comparison-table th {
            background: rgba(30, 36, 53, 0.8);
            color: #39ff14;
        }
        .discrepancy {
            color: #ff6b9d;
            font-weight: bold;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .button:hover { background: #0056b3; }
        .status-notice {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            font-weight: bold;
        }
        .ai-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .ai-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-results {
            background: rgba(30, 36, 53, 0.3);
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #39ff14;
        }
    </style>
</head>
<body>
    <h1>üîç Data Discrepancy Reproduction Test</h1>
    <p>This test reproduces the exact discrepancy reported: Static Analysis showing high values vs AI Analysis showing low values.</p>

    <div class="analysis-section">
        <h2>Static Analysis Results (Baseline)</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Testable Lines of Code</div>
                <div class="metric-value" id="staticLOC">1756</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Cyclomatic Complexity</div>
                <div class="metric-value" id="staticC1">531</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Cognitive Complexity</div>
                <div class="metric-value" id="staticC2">415</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Halstead Complexity</div>
                <div class="metric-value" id="staticC3">415</div>
            </div>
        </div>
    </div>

    <div class="analysis-section">
        <h2>AI Analysis Results (Current Issue)</h2>
        <div class="status-notice ai-warning" id="aiStatusNotice">
            ‚ö†Ô∏è AI Analysis Failed - Using Static Estimate (api_error error) - Model: openai/gpt-oss-20b:free
        </div>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Testable Lines of Code</div>
                <div class="metric-value" id="aiLOC">242</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Cyclomatic Complexity</div>
                <div class="metric-value" id="aiC1">17</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Cognitive Complexity</div>
                <div class="metric-value" id="aiC2">26</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Halstead Complexity</div>
                <div class="metric-value" id="aiC3">109</div>
            </div>
        </div>
    </div>

    <div class="analysis-section">
        <h2>Discrepancy Analysis</h2>
        <table class="comparison-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Static Analysis</th>
                    <th>AI Analysis</th>
                    <th>Discrepancy</th>
                    <th>Percentage Diff</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>LOC</td>
                    <td>1756</td>
                    <td class="discrepancy">242</td>
                    <td class="discrepancy">-1514</td>
                    <td class="discrepancy">-86%</td>
                </tr>
                <tr>
                    <td>Cyclomatic</td>
                    <td>531</td>
                    <td class="discrepancy">17</td>
                    <td class="discrepancy">-514</td>
                    <td class="discrepancy">-97%</td>
                </tr>
                <tr>
                    <td>Cognitive</td>
                    <td>415</td>
                    <td class="discrepancy">26</td>
                    <td class="discrepancy">-389</td>
                    <td class="discrepancy">-94%</td>
                </tr>
                <tr>
                    <td>Halstead</td>
                    <td>415</td>
                    <td class="discrepancy">109</td>
                    <td class="discrepancy">-306</td>
                    <td class="discrepancy">-74%</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="analysis-section">
        <h2>Root Cause Investigation</h2>
        <button class="button" onclick="investigateRootCause()">Investigate Root Cause</button>
        <button class="button" onclick="testCorrectAIResponse()">Test Correct AI Response</button>
        <button class="button" onclick="simulateFallback()">Simulate Fallback Scenario</button>
        <div id="investigationResults" class="test-results" style="display: none;"></div>
    </div>

    <script>
        // Mock functions to investigate the issue
        function parseAIMetrics(text, statusNote = '') {
            try {
                const parsed = JSON.parse(text);
                return {
                    loc: Number(parsed.loc) || 0,
                    c1: Number(parsed.complexity1) || 0,
                    c2: Number(parsed.complexity2) || 0,
                    c3: Number(parsed.complexity3) || 0,
                    notes: parsed.notes || [],
                    parseError: false
                };
            } catch (error) {
                return {
                    loc: 0, c1: 0, c2: 0, c3: 0,
                    notes: ['Parse error'],
                    parseError: true
                };
            }
        }

        function formatForDisplayEnhanced(value) {
            if (value === null || value === undefined) return 'NA';
            const num = Number(value);
            if (!Number.isFinite(num) || num < 0) return 'Invalid';
            return String(Math.round(num));
        }

        function updateAIDisplay(result) {
            document.getElementById('aiLOC').textContent = formatForDisplayEnhanced(result.loc);
            document.getElementById('aiC1').textContent = formatForDisplayEnhanced(result.c1);
            document.getElementById('aiC2').textContent = formatForDisplayEnhanced(result.c2);
            document.getElementById('aiC3').textContent = formatForDisplayEnhanced(result.c3);
        }

        function updateStatusNotice(message, isError = false) {
            const notice = document.getElementById('aiStatusNotice');
            notice.textContent = message;
            if (isError) {
                notice.className = 'status-notice ai-warning';
            } else {
                notice.className = 'status-notice ai-success';
            }
        }

        function investigateRootCause() {
            const results = document.getElementById('investigationResults');
            results.style.display = 'block';
            
            results.innerHTML = `
                <h3>üîç Root Cause Investigation Results</h3>
                <div style="margin: 20px 0;">
                    <h4>Hypothesis 1: AI is actually returning correct but different values</h4>
                    <p><strong>Finding:</strong> The AI might be analyzing a different subset of the code or using different counting methodologies.</p>
                    <p><strong>Evidence:</strong> The values (242, 17, 26, 109) seem too consistent to be random errors.</p>
                    
                    <h4>Hypothesis 2: Fallback mechanism is silently activating</h4>
                    <p><strong>Finding:</strong> When AI analysis fails, the system might be showing cached or default values instead of actual static analysis results.</p>
                    <p><strong>Evidence:</strong> The status notice shows "AI Analysis Failed" but displays different values than static analysis.</p>
                    
                    <h4>Hypothesis 3: Different analysis scope</h4>
                    <p><strong>Finding:</strong> The AI might be analyzing only a portion of the code file due to token limits or parsing issues.</p>
                    <p><strong>Evidence:</strong> 242 LOC vs 1756 LOC suggests the AI is seeing roughly 14% of the total code.</p>
                    
                    <h4>Hypothesis 4: Model output inconsistency</h4>
                    <p><strong>Finding:</strong> Different AI models might interpret the same code differently or have varying analysis capabilities.</p>
                    <p><strong>Evidence:</strong> The status shows "openai/gpt-oss-20b:free" which might have different analysis accuracy than other models.</p>
                </div>
            `;
        }

        function testCorrectAIResponse() {
            const results = document.getElementById('investigationResults');
            results.style.display = 'block';
            
            // Simulate what the AI response should be if it analyzed the same code as static analysis
            const correctAIResponse = '{"loc": 1756, "complexity1": 531, "complexity2": 415, "complexity3": 415, "notes": ["Complete unity.c analysis"]}';
            
            const parsed = parseAIMetrics(correctAIResponse, 'Corrected AI Analysis');
            updateAIDisplay(parsed);
            updateStatusNotice('‚úÖ AI Analysis Complete - Corrected Values', false);
            
            results.innerHTML = `
                <h3>‚úÖ Correct AI Response Test</h3>
                <div style="margin: 20px 0;">
                    <h4>Test Input:</h4>
                    <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px;">${correctAIResponse}</pre>
                    
                    <h4>Results:</h4>
                    <p><strong>LOC:</strong> ${parsed.loc} (matches static analysis ‚úÖ)</p>
                    <p><strong>Cyclomatic:</strong> ${parsed.c1} (matches static analysis ‚úÖ)</p>
                    <p><strong>Cognitive:</strong> ${parsed.c2} (matches static analysis ‚úÖ)</p>
                    <p><strong>Halstead:</strong> ${parsed.c3} (matches static analysis ‚úÖ)</p>
                    
                    <h4>Conclusion:</h4>
                    <p style="color: #39ff14; font-weight: bold;">When the AI provides correct analysis, the values match perfectly. The issue is not in the display logic but in the AI analysis itself or the input being sent to the AI.</p>
                </div>
            `;
        }

        function simulateFallback() {
            const results = document.getElementById('investigationResults');
            results.style.display = 'block';
            
            // Simulate fallback scenario where AI fails and static analysis should be used
            const staticValues = { 
                loc: 1756, 
                c1: 531, 
                c2: 415, 
                c3: 415,
                fallbackUsed: true,
                errorCategory: 'api_error',
                notes: ['AI analysis failed - using static estimate']
            };
            
            updateAIDisplay(staticValues);
            updateStatusNotice('‚ö†Ô∏è AI Analysis Failed - Using Static Estimate (api_error)', true);
            
            results.innerHTML = `
                <h3>‚ö†Ô∏è Fallback Scenario Simulation</h3>
                <div style="margin: 20px 0;">
                    <h4>Fallback Logic:</h4>
                    <p>When AI analysis fails, the system should display static analysis values with a clear warning.</p>
                    
                    <h4>Expected Behavior:</h4>
                    <ul>
                        <li>Display static analysis values (1756, 531, 415, 415)</li>
                        <li>Show clear "AI Analysis Failed" warning</li>
                        <li>Indicate which error caused the fallback</li>
                    </ul>
                    
                    <h4>Actual Issue:</h4>
                    <p style="color: #ff6b9d; font-weight: bold;">The system is showing different values (242, 17, 26, 109) instead of static analysis values. This suggests:</p>
                    <ul>
                        <li>The fallback mechanism is not working correctly</li>
                        <li>Or the AI is returning partial/incorrect analysis that's being accepted as valid</li>
                        <li>Or there's a caching issue showing stale data</li>
                    </ul>
                    
                    <h4>Recommended Fix:</h4>
                    <ol>
                        <li>Verify the AI is receiving the complete code file</li>
                        <li>Check if token limits are truncating the input</li>
                        <li>Ensure fallback logic uses actual static analysis results</li>
                        <li>Add logging to track which values are being displayed and why</li>
                    </ol>
                </div>
            `;
        }

        // Initialize the page
        window.addEventListener('load', function() {
            console.log('üîç Data Discrepancy Reproduction Test loaded');
            console.log('üìä Static Analysis: LOC=1756, C1=531, C2=415, C3=415');
            console.log('ü§ñ AI Analysis (Current): LOC=242, C1=17, C2=26, C3=109');
            console.log('üìâ Discrepancy: 86% lower LOC, 97% lower C1, 94% lower C2, 74% lower C3');
        });
    </script>
</body>
</html>
